<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:html="http://www.w3.org/1999/xhtml" xmlns:fn="http://www.w3.org/2005/xpath-functions">
  <head>
    <title>jMock - Mocking GWT Asynchronous Services</title>
    <link media="screen" rel="stylesheet" type="text/css" href="./jmock.css"/>
    <link media="print" rel="stylesheet" type="text/css" href="./print.css"/>
    <link rel="icon" type="image/png" href="./icon.png"/>
    <meta http-equiv="Content-Script-Type" content="text/javascript"/>
    <script type="text/javascript" src="prefs.js">
      
    </script>
  </head>
  <body onload="restorePreferredTestFramework()">
    <div id="banner">
      <a href="./index.html">
        <img id="logo" src="logo.png" alt="jMock"/>
      </a>
    </div>
    <div id="center" class="Content">
      <div id="content">
        <h1>Mocking GWT Asynchronous Services</h1>
        <p>You can use jMock to unit test objects that use asynchronous GWT services by
using a custom action to capture the asynchronous callback passed to the service
request. Once it has captured the callback, the action can invoke it to indicate success or
failure of the asynchronous call.</p>
        <p>Here's an implementation of this idea:</p>
        <pre class="Java Source">public class AsyncAction&lt;T&gt; implements Action {
    private AsyncCallback&lt;T&gt; callback;

    public void succeedGiving(T result) {
        checkCallback();
        callback.onSuccess(result);
    }

    public void fail(Throwable caught) {
        checkCallback();
        callback.onFailure(caught);
    }

    public void describeTo(Description description) {
        description.appendText("requests an async callback");
    }

    private void checkCallback() {
        if (callback == null) {
            Assert.fail("asynchronous action not scheduled");
        }
    }

    @SuppressWarnings("unchecked")
    public Object invoke(Invocation invocation) throws Throwable {
        callback = (AsyncCallback&lt;T&gt;)invocation.getParameter(invocation.getParameterCount()-1);
        return null;
    }
}</pre>
        <p>You can use it in tests like this:</p>
        <pre class="Java Source">ServiceAsync service = context.mock(ServiceAsync.class, "service");
ObjectUnderTest objectUnderTest = new ObjectUnderTest(service);

@Test
public void loadsScenariosAsynchronously() throws Exception {
    final AsyncAction&lt;String&gt; makeAsyncRequest = new AsyncAction&lt;String&gt;();

    context.checking(new Expectations() {{
        oneOf(service).getSomething(with(any(AsyncCallback.class))); will(makeAsyncRequest);
    }});
    
    objectUnderTest.doSomething();
    makeAsyncRequest.succeedGiving("foo");
    
    assertThat(objectUnderTest.thingThatItGotAsynchronously(), equalTo("foo"));
}</pre>
      </div>
    </div>
    <div id="navigation">
      <div class="MenuGroup">
        <h1>
          <a href="download.html">Software</a>
        </h1>
        <versions xmlns="">
  <h2 xmlns="http://www.w3.org/1999/xhtml">jMock 2 (Java 1.6)</h2><ul xmlns="http://www.w3.org/1999/xhtml"><li><a href="./download.html">Stable: 2.6.1</a></li></ul>
  <h2 xmlns="http://www.w3.org/1999/xhtml">jMock 1 (Java 1.3+)</h2><ul xmlns="http://www.w3.org/1999/xhtml"><li><a href="./download.html">Stable: 1.2.0</a></li></ul>
</versions>
        <p>
          <a href="./repository.html">Source Repository</a>
        </p>
        <p>
          <a href="./license.html">Project License</a>
        </p>
        <p>
          <a href="./versioning.html">Version Numbering</a>
        </p>
        <p>
          <a href="./extensions.html">Extensions</a>
        </p>
      </div>
      <div class="MenuGroup">
        <h1>Documentation</h1>
        <p>
          <a href="./getting-started.html">Getting Started</a>
        </p>
        <p>
          <a href="./cookbook.html">Cookbook</a>
        </p>
        <p>
          <a href="./cheat-sheet.html">Cheat Sheet</a>
        </p>
        <p>
          <a href="./javadoc.html">API Documentation</a>
        </p>
        <p>
          <a href="./articles.html">Articles and Papers</a>
        </p>
        <p>
          <a href="./jmock1.html">jMock 1 Documentation</a>
        </p>
        <p>
          <a href="http://www.mockobjects.com">About Mock Objects</a>
        </p>
      </div>
      <div class="MenuGroup">
        <h1>User Support</h1>
        <p>
          <a href="./mailing-lists.html">Mailing Lists</a>
        </p>
        <p>
          <a href="http://www.musketeer-labs.com/">Training</a>
        </p>
        <p>
          <a href="https://github.com/jmock-developers/jmock-library/issues">Issue Tracker</a>
        </p>
        <p>
          <a href="./news-rss2.xml">News Feed (RSS 2.0)</a>
        </p>
      </div>
      <div class="MenuGroup">
        <h1>Credits</h1>
        <p>
          <a href="./team.html">Development Team</a>
        </p>
        <p>
          <a href="http://www.github.com">Project hosted by Github</a>
        </p>
        <p>
          <a href="http://tango.freedesktop.org">Icons by the Tango Project</a>
        </p>
      </div>
    </div>
  </body>
</html>
