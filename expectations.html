<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:html="http://www.w3.org/1999/xhtml" xmlns:fn="http://www.w3.org/2005/xpath-functions">
  <head>
    <title>jMock - Specifying Expectations</title>
    <link media="screen" rel="stylesheet" type="text/css" href="./jmock.css"/>
    <link media="print" rel="stylesheet" type="text/css" href="./print.css"/>
    <link rel="icon" type="image/png" href="./icon.png"/>
    <meta http-equiv="Content-Script-Type" content="text/javascript"/>
    <script type="text/javascript" src="prefs.js">
      
    </script>
  </head>
  <body onload="restorePreferredTestFramework()">
    <div id="banner">
      <a href="./index.html">
        <img id="logo" src="logo.png" alt="jMock"/>
      </a>
    </div>
    <div id="center" class="Content">
      <div id="content">
        <h1>Specifying Expectations</h1>
        <p>Expectations are defined within a "Double-Brace Block" that defines the
    expectations in the context of the the test's Mockery (identified as
    <var>context</var> in the examples below). In outline, a jMock 2 test
    looks like the following:</p>
        <div class="Raw">
          <div class="ExampleTestFrameworkSelector">
      	   Show for:
      	   <a class="SelectorJUnit3" href="javascript:selectTestFramework('JUnit3')">JUnit 3</a><a class="SelectorJUnit4" href="javascript:selectTestFramework('JUnit4')">JUnit 4</a><a class="SelectorRaw" href="javascript:selectTestFramework('Raw')">Other</a></div>
          <h3>Raw</h3>
          <pre class="Java Source">public void testSomeAction() {
    ... set up ...
    
    context.checking(new Expectations() {{
        ... expectations go here ...
    }});
    
    ... code being tested ...
    
    context.assertIsSatisfied();
    
    ... other assertions ...
}</pre>
        </div>
        <div class="JUnit3">
          <div class="ExampleTestFrameworkSelector">
      	   Show for:
      	   <a class="SelectorJUnit3" href="javascript:selectTestFramework('JUnit3')">JUnit 3</a><a class="SelectorJUnit4" href="javascript:selectTestFramework('JUnit4')">JUnit 4</a><a class="SelectorRaw" href="javascript:selectTestFramework('Raw')">Other</a></div>
          <h3>JUnit 3 Integration</h3>
          <pre class="Java Source">public void testSomeAction() {
    ... set up ...
    
    checking(new Expectations() {{
        ... expectations go here ...
    }});
    
    ... code being tested ...
    
    ... assertions ...
}</pre>
        </div>
        <div class="JUnit4">
          <div class="ExampleTestFrameworkSelector">
      	   Show for:
      	   <a class="SelectorJUnit3" href="javascript:selectTestFramework('JUnit3')">JUnit 3</a><a class="SelectorJUnit4" href="javascript:selectTestFramework('JUnit4')">JUnit 4</a><a class="SelectorRaw" href="javascript:selectTestFramework('Raw')">Other</a></div>
          <h3>JUnit 4 Integration</h3>
          <pre class="Java Source">public void testSomeAction() {
    ... set up ...
    
    context.checking(new Expectations() {{
        ... expectations go here ...
    }});
    
    ... code being tested ...
    
    ... assertions ...
}</pre>
        </div>
        <p>An expectations block can contain any number of expectations. Each
    expectation has the following structure:</p>
        <pre class="Source Java"><var>invocation-count</var> (<var>mock-object</var>).<var>method</var>(<var>argument-constraints</var>);
    inSequence(<var>sequence-name</var>);
    when(<var>state-machine</var>.is(<var>state-name</var>));
    will(<var>action</var>);
    then(<var>state-machine</var>.is(<var>new-state-name</var>));</pre>
        <p>Except for the <a href="cardinality.html">invocation count</a><sup class="LinkFootnoteRef">1</sup> and the
    mock object, all clauses are optional. You can give an expectation as many
    <code><a href="sequences.html">inSequence</a><sup class="LinkFootnoteRef">2</sup></code>, <code><a href="states.html">when</a><sup class="LinkFootnoteRef">3</sup></code>, <code>will</code> and <code><a href="states.html">then</a><sup class="LinkFootnoteRef">4</sup></code> clauses as you wish.</p>
        <p>The following test defines several expectations:</p>
        <div class="JUnit3">
          <div class="ExampleTestFrameworkSelector">
      	   Show for:
      	   <a class="SelectorJUnit3" href="javascript:selectTestFramework('JUnit3')">JUnit 3</a><a class="SelectorJUnit4" href="javascript:selectTestFramework('JUnit4')">JUnit 4</a><a class="SelectorRaw" href="javascript:selectTestFramework('Raw')">Other</a></div>
          <h3>JUnit3 Integration</h3>
          <pre class="Java Source">public void testReturnsCachedObjectWithinTimeout() {
    checking(new Expectations() {{
        oneOf (clock).time(); will(returnValue(loadTime));
        oneOf (clock).time(); will(returnValue(fetchTime));
            
        allowing (reloadPolicy).shouldReload(loadTime, fetchTime); will(returnValue(false));
        
        oneOf (loader).load(KEY); will(returnValue(VALUE));
    }});
    
    Object actualValueFromFirstLookup = cache.lookup(KEY);
    Object actualValueFromSecondLookup = cache.lookup(KEY);
        
    assertSame("should be loaded object", VALUE, actualValueFromFirstLookup);
    assertSame("should be cached object", VALUE, actualValueFromSecondLookup);
}</pre>
        </div>
        <div class="JUnit4">
          <div class="ExampleTestFrameworkSelector">
      	   Show for:
      	   <a class="SelectorJUnit3" href="javascript:selectTestFramework('JUnit3')">JUnit 3</a><a class="SelectorJUnit4" href="javascript:selectTestFramework('JUnit4')">JUnit 4</a><a class="SelectorRaw" href="javascript:selectTestFramework('Raw')">Other</a></div>
          <h3>JUnit4 Integration</h3>
          <pre class="Java Source">@Test public void 
returnsCachedObjectWithinTimeout() {
    context.checking(new Expectations() {{
        oneOf (clock).time(); will(returnValue(loadTime));
        oneOf (clock).time(); will(returnValue(fetchTime));
            
        allowing (reloadPolicy).shouldReload(loadTime, fetchTime); will(returnValue(false));
        
        oneOf (loader).load(KEY); will(returnValue(VALUE));
    }});
        
    Object actualValueFromFirstLookup = cache.lookup(KEY);
    Object actualValueFromSecondLookup = cache.lookup(KEY);
        
    assertSame("should be loaded object", VALUE, actualValueFromFirstLookup);
    assertSame("should be cached object", VALUE, actualValueFromSecondLookup);
}</pre>
        </div>
        <div class="Raw">
          <div class="ExampleTestFrameworkSelector">
      	   Show for:
      	   <a class="SelectorJUnit3" href="javascript:selectTestFramework('JUnit3')">JUnit 3</a><a class="SelectorJUnit4" href="javascript:selectTestFramework('JUnit4')">JUnit 4</a><a class="SelectorRaw" href="javascript:selectTestFramework('Raw')">Other</a></div>
          <h3>Raw</h3>
          <pre class="Java Source">public void testReturnsCachedObjectWithinTimeout() {
    context.checking(new Expectations() {{
        oneOf (clock).time(); will(returnValue(loadTime));
        oneOf (clock).time(); will(returnValue(fetchTime));
            
        allowing (reloadPolicy).shouldReload(loadTime, fetchTime); will(returnValue(false));
        
        oneOf (loader).load(KEY); will(returnValue(VALUE));
    }});
        
    Object actualValueFromFirstLookup = cache.lookup(KEY);
    Object actualValueFromSecondLookup = cache.lookup(KEY);
        
    context.assertIsSatisfied();
    assertSame("should be loaded object", VALUE, actualValueFromFirstLookup);
    assertSame("should be cached object", VALUE, actualValueFromSecondLookup);
}</pre>
        </div>
        <p>Because the expectations are defined within an anonymous inner class,
    any mock objects (or other values) that are stored in local variables and
    referenced from within the expectations block must be final. It is often
    more convenient to store mock objects in instance variables and define
    constants for the values used in the test, as the examples above do.
    Constants have the added benefit of making the test easier to understand
    than they would be if unnamed, literal values were used.</p>
        <p>A test can contain multiple expectation blocks. Expectations in later
    blocks are appended to those in earlier blocks. This can be used to
    clarify exactly when expected calls will happen in response to calls to
    the object under test. For example, the test above can be rewritten as
    follows to more clearly express when the cache loads an object will be
    loaded and when it returns a cached copy:</p>
        <div class="JUnit3">
          <div class="ExampleTestFrameworkSelector">
      	   Show for:
      	   <a class="SelectorJUnit3" href="javascript:selectTestFramework('JUnit3')">JUnit 3</a><a class="SelectorJUnit4" href="javascript:selectTestFramework('JUnit4')">JUnit 4</a><a class="SelectorRaw" href="javascript:selectTestFramework('Raw')">Other</a></div>
          <h3>JUnit3 Integration</h3>
          <pre class="Java Source">public void testReturnsCachedObjectWithinTimeout() {
    checking(new Expectations() {{
        oneOf (clock).time(); will(returnValue(loadTime));
        oneOf (loader).load(KEY); will(returnValue(VALUE));
    }});

    Object actualValueFromFirstLookup = cache.lookup(KEY);

    checking(new Expectations() {{
        oneOf (clock).time(); will(returnValue(fetchTime));            
        allowing (reloadPolicy).shouldReload(loadTime, fetchTime); will(returnValue(false));
    }});
    
    Object actualValueFromSecondLookup = cache.lookup(KEY);
        
    assertSame("should be loaded object", VALUE, actualValueFromFirstLookup);
    assertSame("should be cached object", VALUE, actualValueFromSecondLookup);
}</pre>
        </div>
        <div class="JUnit4">
          <div class="ExampleTestFrameworkSelector">
      	   Show for:
      	   <a class="SelectorJUnit3" href="javascript:selectTestFramework('JUnit3')">JUnit 3</a><a class="SelectorJUnit4" href="javascript:selectTestFramework('JUnit4')">JUnit 4</a><a class="SelectorRaw" href="javascript:selectTestFramework('Raw')">Other</a></div>
          <h3>JUnit4 Integration</h3>
          <pre class="Java Source">@Test public void 
returnsCachedObjectWithinTimeout() {
    context.checking(new Expectations() {{
        oneOf (clock).time(); will(returnValue(loadTime));
        oneOf (loader).load(KEY); will(returnValue(VALUE));
    }});

    Object actualValueFromFirstLookup = cache.lookup(KEY);

    context.checking(new Expectations() {{
        oneOf (clock).time(); will(returnValue(fetchTime));            
        allowing (reloadPolicy).shouldReload(loadTime, fetchTime); will(returnValue(false));
    }});
    
    Object actualValueFromSecondLookup = cache.lookup(KEY);
        
    assertSame("should be loaded object", VALUE, actualValueFromFirstLookup);
    assertSame("should be cached object", VALUE, actualValueFromSecondLookup);
}</pre>
        </div>
        <div class="Raw">
          <div class="ExampleTestFrameworkSelector">
      	   Show for:
      	   <a class="SelectorJUnit3" href="javascript:selectTestFramework('JUnit3')">JUnit 3</a><a class="SelectorJUnit4" href="javascript:selectTestFramework('JUnit4')">JUnit 4</a><a class="SelectorRaw" href="javascript:selectTestFramework('Raw')">Other</a></div>
          <h3>Raw</h3>
          <pre class="Java Source">public void testReturnsCachedObjectWithinTimeout() {
    context.checking(new Expectations() {{
        oneOf (clock).time(); will(returnValue(loadTime));
        oneOf (loader).load(KEY); will(returnValue(VALUE));
    }});

    Object actualValueFromFirstLookup = cache.lookup(KEY);

    context.checking(new Expectations() {{
        oneOf (clock).time(); will(returnValue(fetchTime));            
        allowing (reloadPolicy).shouldReload(loadTime, fetchTime); will(returnValue(false));
    }});
    
    Object actualValueFromSecondLookup = cache.lookup(KEY);
        
    context.assertIsSatisfied();
    assertSame("should be loaded object", VALUE, actualValueFromFirstLookup);
    assertSame("should be cached object", VALUE, actualValueFromSecondLookup);
}</pre>
        </div>
        <p>Expectations do not have to be defined in the body of the test method.
    You can define expectations in helper methods or the <code>setUp</code>
    method to remove duplication or clarify the test code.</p>
        <div class="JUnit3">
          <div class="ExampleTestFrameworkSelector">
      	   Show for:
      	   <a class="SelectorJUnit3" href="javascript:selectTestFramework('JUnit3')">JUnit 3</a><a class="SelectorJUnit4" href="javascript:selectTestFramework('JUnit4')">JUnit 4</a><a class="SelectorRaw" href="javascript:selectTestFramework('Raw')">Other</a></div>
          <h3>JUnit3 Integration</h3>
          <pre class="Java Source">public void testReturnsCachedObjectWithinTimeout() {
    initiallyLoads(VALUE);

    Object valueFromFirstLookup = cache.lookup(KEY);

    cacheHasNotExpired();
    
    Object valueFromSecondLookup = cache.lookup(KEY);
        
    assertSame("should have returned cached object", 
               valueFromFirstLookup, valueFromSecondLookup);
}

private void initiallyLoads(Object value) {
    checking(new Expectations() {{
        oneOf (clock).time(); will(returnValue(loadTime));
        oneOf (loader).load(KEY); will(returnValue(value));
    }});
}

private void cacheHasNotExpired() {
    checking(new Expectations() {{
        oneOf (clock).time(); will(returnValue(fetchTime));            
        allowing (reloadPolicy).shouldReload(loadTime, fetchTime); will(returnValue(false));
    }});
}</pre>
        </div>
        <div class="JUnit4">
          <div class="ExampleTestFrameworkSelector">
      	   Show for:
      	   <a class="SelectorJUnit3" href="javascript:selectTestFramework('JUnit3')">JUnit 3</a><a class="SelectorJUnit4" href="javascript:selectTestFramework('JUnit4')">JUnit 4</a><a class="SelectorRaw" href="javascript:selectTestFramework('Raw')">Other</a></div>
          <h3>JUnit4 Integration</h3>
          <pre class="Java Source">@Test public void 
returnsCachedObjectWithinTimeout() {
    initiallyLoads(VALUE);

    Object valueFromFirstLookup = cache.lookup(KEY);

    cacheHasNotExpired();
    
    Object valueFromSecondLookup = cache.lookup(KEY);
    
    assertSame("should have returned cached object", 
               valueFromFirstLookup, valueFromSecondLookup);
}

private void initiallyLoads(Object value) {
    context.checking(new Expectations() {{
        oneOf (clock).time(); will(returnValue(loadTime));
        oneOf (loader).load(KEY); will(returnValue(value));
    }});
}

private void cacheHasNotExpired() {
    context.checking(new Expectations() {{
        oneOf (clock).time(); will(returnValue(fetchTime));            
        allowing (reloadPolicy).shouldReload(loadTime, fetchTime); will(returnValue(false));
    }});
}</pre>
        </div>
        <div class="Raw">
          <div class="ExampleTestFrameworkSelector">
      	   Show for:
      	   <a class="SelectorJUnit3" href="javascript:selectTestFramework('JUnit3')">JUnit 3</a><a class="SelectorJUnit4" href="javascript:selectTestFramework('JUnit4')">JUnit 4</a><a class="SelectorRaw" href="javascript:selectTestFramework('Raw')">Other</a></div>
          <h3>Raw</h3>
          <pre class="Java Source">public void testReturnsCachedObjectWithinTimeout() {
    initiallyLoads(VALUE);

    Object valueFromFirstLookup = cache.lookup(KEY);

    cacheHasNotExpired();
    
    Object valueFromSecondLookup = cache.lookup(KEY);
    
    context.assertIsSatisfied();
    assertSame("should have returned cached object", 
               valueFromFirstLookup, valueFromSecondLookup);
}

private void initiallyLoads(Object value) {
    context.checking(new Expectations() {{
        oneOf (clock).time(); will(returnValue(loadTime));
        oneOf (loader).load(KEY); will(returnValue(value));
    }});
}

private void cacheHasNotExpired() {
    context.checking(new Expectations() {{
        oneOf (clock).time(); will(returnValue(fetchTime));            
        allowing (reloadPolicy).shouldReload(loadTime, fetchTime); will(returnValue(false));
    }});
}</pre>
        </div>
      </div>
      <div class="LinkFootnotes">
        <p class="LinkFootnotesHeader">Links:</p>
        <p>1.
	  				invocation count:
	  				
	  				http://www.jmock.org/cardinality.html</p>
        <p>2.
	  				inSequence:
	  				
	  				http://www.jmock.org/sequences.html</p>
        <p>3.
	  				when:
	  				
	  				http://www.jmock.org/states.html</p>
        <p>4.
	  				then:
	  				
	  				http://www.jmock.org/states.html</p>
      </div>
    </div>
    <div id="navigation">
      <div class="MenuGroup">
        <h1>
          <a href="download.html">Software</a>
        </h1>
        <versions xmlns="">
  <h2 xmlns="http://www.w3.org/1999/xhtml">jMock 2 (Java 1.5+)</h2><ul xmlns="http://www.w3.org/1999/xhtml"><li><a href="./download.html">Unstable: 2.6.0-RC2</a></li><li><a href="./download.html">Stable: 2.5.1</a></li></ul>
  <h2 xmlns="http://www.w3.org/1999/xhtml">jMock 1 (Java 1.3+)</h2><ul xmlns="http://www.w3.org/1999/xhtml"><li><a href="./download.html">Stable: 1.2.0</a></li></ul>
</versions>
        <p>
          <a href="./repository.html">Source Repository</a>
        </p>
        <p>
          <a href="./license.html">Project License</a>
        </p>
        <p>
          <a href="./versioning.html">Version Numbering</a>
        </p>
        <p>
          <a href="./extensions.html">Extensions</a>
        </p>
      </div>
      <div class="MenuGroup">
        <h1>Documentation</h1>
        <p>
          <a href="./getting-started.html">Getting Started</a>
        </p>
        <p>
          <a href="./cookbook.html">Cookbook</a>
        </p>
        <p>
          <a href="./cheat-sheet.html">Cheat Sheet</a>
        </p>
        <p>
          <a href="./javadoc.html">API Documentation</a>
        </p>
        <p>
          <a href="./articles.html">Articles and Papers</a>
        </p>
        <p>
          <a href="./jmock1.html">jMock 1 Documentation</a>
        </p>
        <p>
          <a href="http://www.mockobjects.com">About Mock Objects</a>
        </p>
      </div>
      <div class="MenuGroup">
        <h1>User Support</h1>
        <p>
          <a href="./mailing-lists.html">Mailing Lists</a>
        </p>
        <p>
          <a href="http://www.musketeer-labs.com/">Training</a>
        </p>
        <p>
          <a href="http://jira.codehaus.org/secure/BrowseProject.jspa?id=10336">Issue Tracker</a>
        </p>
        <p>
          <a href="./news-rss2.xml">News Feed (RSS 2.0)</a>
        </p>
      </div>
      <div class="MenuGroup">
        <h1>Credits</h1>
        <p>
          <a href="./team.html">Development Team</a>
        </p>
        <p>
          <a href="http://www.codehaus.org">Project hosted by Codehaus</a>
        </p>
        <p>
          <a href="http://tango.freedesktop.org">Icons by the Tango Project</a>
        </p>
      </div>
    </div>
  </body>
</html>
