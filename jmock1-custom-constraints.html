<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:html="http://www.w3.org/1999/xhtml" xmlns:fn="http://www.w3.org/2005/xpath-functions">
  <head>
    <title>jMock - Writing Custom Constraints</title>
    <link media="screen" rel="stylesheet" type="text/css" href="./jmock.css"/>
    <link media="print" rel="stylesheet" type="text/css" href="./print.css"/>
    <link rel="icon" type="image/png" href="./icon.png"/>
    <meta http-equiv="Content-Script-Type" content="text/javascript"/>
    <script type="text/javascript" src="prefs.js">
      
    </script>
  </head>
  <body onload="restorePreferredTestFramework()">
    <div id="banner">
      <a href="./index.html">
        <img id="logo" src="logo.png" alt="jMock"/>
      </a>
    </div>
    <div id="center" class="Content">
      <div id="content">
        <h1>jMock 1: Writing Custom Constraints</h1>
        <p>jMock provides several classes and factory functions that define <a href="jmock1-constraints.html">constraints over the acceptable parameter
    values of a method invocation</a><sup class="LinkFootnoteRef">1</sup>. Sometimes, however, the predefined
    constraints do not let you specify an expectation accurately enough to
    keep your tests flexible. In such cases, you can easily define new
    constraints that seamlessly extend the existing constraints defined by
    jMock.</p>
        <p>A constraint is an object that implements the <code>Constraint</code>
    interface. It does two things:</p>
        <ul>
      <li>report whether a parameter value meets the constraint (the
      <code>eval</code> method).</li>

      <li>provide a readable description to be included in test failure
      messages (the <code>describeTo</code> method from the
      <code>SelfDescribing</code> interface).</li>
    </ul>
        <p>The <code>org.jmock.constraint</code> package contains many constraint
    implementations and the programmer can easily specify their own
    constraints by writing their own implementations of the
    <code>Constraint</code> interface.</p>
        <p>To create a new constraint:</p>
        <ol>
      <li><p>Write a class that implements the <code>Constraint</code>
      interface. The following constraint class tests whether a string starts
      with a given prefix.</p> <div class="Source Java"> <pre>import org.jmock.core.Constraint;

public class StringStartsWith implements Constraint {
    private String prefix;

    public StringStartsWith( String prefix ) {
        this.prefix = prefix;
    }

    public boolean eval( Object o ) {
        return o instanceof String &amp;&amp; ((String)o).startsWith(prefix);
    }

    public StringBuffer describeTo( StringBuffer buffer ) {
        return buffer.append("a string starting with ")
                     .append(Formatting.toReadableString(prefix));
    }
}</pre> </div> <p>Note that the <code>describeTo</code> method calls
      <code>Formatting.toReadableString</code> to format the prefix. The
      <code>toReadableString</code> method formats any raw value in a way that
      subtly indicates the value's type and should be used to format any raw
      values stored in your constraints so that error messages are easy to
      read.</p></li>

      <li><p>Write a factory method in your test case that creates an instance
      of your new constraint.</p> <div class="Source Java"> <pre>public class MyTestCase extends MockObjectTestCase {
    ...

    private Constraint aStringStartingWith( String prefix ) {
        return new StringStartsWith(prefix);
    }
}</pre> </div></li>

      <li><p>Use your factory method to create constraints in your tests. The
      following expectation specifies that the error method of the mockLogger
      object must be called once with an argument that is a string starting
      with "FATAL".</p> <div class="Source Java"> <pre>public class MyTestCase extends MockObjectTestCase {
    ...

    public void testSomething() {
        ...

        mockLogger.expects(once()).method("error").with( aStringStartingWith("FATAL") );

        ...
    }

    private Constraint aStringStartingWith( String prefix ) {
        return new StringStartsWith(prefix);
    }
}</pre> </div></li>
    </ol>
        <h2>An Important Rule</h2>
        <p>
          <strong>Constraint objects must be stateless.</strong>
        </p>
        <p>When <a href="jmock1-dispatch.html">dispatching</a><sup class="LinkFootnoteRef">2</sup> each invocation,
    jMock uses the constraints to find an expectation that matches the
    invocation's arguments. This means that it will call the constraints many
    times during the test, maybe even after the expectation has been matched
    and invoked. In fact, jMock gives no guarantees of when and how many times
    it will call the constraints. This has no effect on stateless constraint
    objects but means that the function of stateful constraint objects cannot
    be predicted.</p>
        <p>If you want to maintain state in response to invocations, use a custom
    <a href="jmock1-custom-stubs.html">Stub</a><sup class="LinkFootnoteRef">3</sup> or <a href="jmock1-custom-matchers.html">Matcher</a><sup class="LinkFootnoteRef">4</sup>.</p>
      </div>
      <div class="LinkFootnotes">
        <p class="LinkFootnotesHeader">Links:</p>
        <p>1.
	  				constraints over the acceptable parameter
    values of a method invocation:
	  				
	  				http://www.jmock.org/jmock1-constraints.html</p>
        <p>2.
	  				dispatching:
	  				
	  				http://www.jmock.org/jmock1-dispatch.html</p>
        <p>3.
	  				Stub:
	  				
	  				http://www.jmock.org/jmock1-custom-stubs.html</p>
        <p>4.
	  				Matcher:
	  				
	  				http://www.jmock.org/jmock1-custom-matchers.html</p>
      </div>
    </div>
    <div id="navigation">
      <div class="MenuGroup">
        <h1>
          <a href="download.html">Software</a>
        </h1>
        <versions xmlns="">
  <h2 xmlns="http://www.w3.org/1999/xhtml">jMock 2 (Java 1.5+)</h2><ul xmlns="http://www.w3.org/1999/xhtml"><li><a href="./download.html">Unstable: 2.6.0-RC2</a></li><li><a href="./download.html">Stable: 2.5.1</a></li></ul>
  <h2 xmlns="http://www.w3.org/1999/xhtml">jMock 1 (Java 1.3+)</h2><ul xmlns="http://www.w3.org/1999/xhtml"><li><a href="./download.html">Stable: 1.2.0</a></li></ul>
</versions>
        <p>
          <a href="./repository.html">Source Repository</a>
        </p>
        <p>
          <a href="./license.html">Project License</a>
        </p>
        <p>
          <a href="./versioning.html">Version Numbering</a>
        </p>
        <p>
          <a href="./extensions.html">Extensions</a>
        </p>
      </div>
      <div class="MenuGroup">
        <h1>Documentation</h1>
        <p>
          <a href="./getting-started.html">Getting Started</a>
        </p>
        <p>
          <a href="./cookbook.html">Cookbook</a>
        </p>
        <p>
          <a href="./cheat-sheet.html">Cheat Sheet</a>
        </p>
        <p>
          <a href="./javadoc.html">API Documentation</a>
        </p>
        <p>
          <a href="./articles.html">Articles and Papers</a>
        </p>
        <p>
          <a href="./jmock1.html">jMock 1 Documentation</a>
        </p>
        <p>
          <a href="http://www.mockobjects.com">About Mock Objects</a>
        </p>
      </div>
      <div class="MenuGroup">
        <h1>User Support</h1>
        <p>
          <a href="./mailing-lists.html">Mailing Lists</a>
        </p>
        <p>
          <a href="http://www.musketeer-labs.com/">Training</a>
        </p>
        <p>
          <a href="http://jira.codehaus.org/secure/BrowseProject.jspa?id=10336">Issue Tracker</a>
        </p>
        <p>
          <a href="./news-rss2.xml">News Feed (RSS 2.0)</a>
        </p>
      </div>
      <div class="MenuGroup">
        <h1>Credits</h1>
        <p>
          <a href="./team.html">Development Team</a>
        </p>
        <p>
          <a href="http://www.codehaus.org">Project hosted by Codehaus</a>
        </p>
        <p>
          <a href="http://tango.freedesktop.org">Icons by the Tango Project</a>
        </p>
      </div>
    </div>
  </body>
</html>
